<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <title>ã‚«ã‚¹ãƒãƒ©å¯¾ç­–è¨ºæ–­</title>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #f0f2f5; padding: 20px; color: #333; }
    h2 { text-align: center; color: #00b900; }
    .card { background: white; padding: 15px; border-radius: 10px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .question { font-weight: bold; margin-bottom: 10px; display: block; }
    .btn { background-color: #06c755; color: white; border: none; padding: 15px; width: 100%; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; }
    .btn:disabled { background-color: #ccc; }
    #status { text-align: center; margin-top: 10px; font-size: 12px; color: #666; }
    select { width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 5px; border: 1px solid #ccc; }
  </style>
</head>
<body>
  <h2>ğŸ›¡ï¸ ã‚«ã‚¹ãƒãƒ©å¯¾ç­–ãƒã‚§ãƒƒã‚¯</h2>
  <div id="form-container">
    <div class="card">
      <span class="question">ã‚ãªãŸã®ç«‹å ´ã‚’é¸æŠã—ã¦ãã ã•ã„</span>
      <select id="role">
        <option value="çµŒå–¶è€…">çµŒå–¶è€…ãƒ»ç®¡ç†è€…</option>
        <option value="ã‚¹ã‚¿ãƒƒãƒ•">ã‚¹ã‚¿ãƒƒãƒ•ãƒ»è·å“¡</option>
      </select>
    </div>
    <div id="questions-area"></div>
    <button id="submit-btn" class="btn" onclick="submitForm()">è¨ºæ–­ã—ã¦AIã«ç›¸è«‡ã™ã‚‹</button>
  </div>
  <p id="status">LINEãƒ­ã‚°ã‚¤ãƒ³ä¸­...</p>

  <script>
    // â–¼â–¼ è¨­å®šæ¸ˆã¿ â–¼â–¼
    const MY_LIFF_ID = '2008705180-p9GbufqO'; 
    const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbzxCmKqDptziWA0EkRSq45qDkEy9a7F64qXEYqZJgMdnExUfpYp_8vaXmm7aj1OxIcR-A/exec';

    const questions = [
      "â‘ ã‚«ã‚¹ãƒãƒ©å¯¾ç­–ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ",
      "â‘¡å…¥è·æ™‚ã«å¯¾ç­–ã‚’æ•™ãˆã¦ã¾ã™ã‹ï¼Ÿ",
      "â‘¢ã‚«ã‚¹ãƒãƒ©å¯¾ç­–ç ”ä¿®ã—ã¦ã¾ã™ã‹ï¼Ÿ",
      "â‘£ã‚«ã‚¹ãƒãƒ©å¯¾ç­–ç ”ä¿®ã€éå¸¸å‹¤è·å“¡å«ã‚€å…¨è·å“¡å—è¬›ã—ã¦ã„ã¾ã™ã‹ï¼Ÿ",
      "â‘¤ã‚«ã‚¹ãƒãƒ©å¯¾ç­–ã‚°ãƒƒã‚ºã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ",
      "â‘¥ã‚«ã‚¹ãƒãƒ©ç›¸è«‡çª“å£ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ",
      "â‘¦ã‚«ã‚¹ãƒãƒ©ã®å®šç¾©ãŒè¨€ãˆã¾ã™ã‹ï¼Ÿ",
      "â‘§ã‚«ã‚¹ãƒãƒ©ã«é–¢ã™ã‚‹ã‚«ãƒ³ãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹ã¯ã—ã¦ã¾ã™ã‹ï¼Ÿ",
      "â‘¨ã‚«ã‚¹ãƒãƒ©å¯¾ç­–ã‚’å®šæœŸçš„ã«è¦‹ç›´ã—ã¦ã„ã¾ã™ã‹ï¼Ÿ",
      "â‘©ã‚«ã‚¹ãƒãƒ©ã‚’ã—ã¦ãã‚‹åˆ©ç”¨è€…å®¶æ—ã«æ›¸é¢ãªã©ã§æ³¨æ„ã‚’ã—ã¦ã„ã¾ã™ã‹ï¼Ÿ"
    ];

    window.onload = function() {
      const area = document.getElementById('questions-area');
      questions.forEach((q, index) => {
        const div = document.createElement('div');
        div.className = 'card';
        div.innerHTML = `
          <span class="question">${q}</span>
          <div class="options">
            <label><input type="radio" name="q${index}" value="Yes"> Yes</label>
            <label><input type="radio" name="q${index}" value="No"> No</label>
          </div>
        `;
        area.appendChild(div);
      });
      initializeLiff(MY_LIFF_ID);
    };

    function initializeLiff(liffId) {
      liff.init({ liffId: liffId })
        .then(() => {
          if (!liff.isLoggedIn()) {
            liff.login();
          } else {
            document.getElementById('status').innerText = "æº–å‚™å®Œäº†";
          }
        })
        .catch((err) => {
          document.getElementById('status').innerText = "ã‚¨ãƒ©ãƒ¼: " + err;
        });
    }

    function submitForm() {
      if (!liff.isLoggedIn()) { liff.login(); return; }

      const role = document.getElementById('role').value;
      const answers = [];
      
      for (let i = 0; i < questions.length; i++) {
        const radios = document.getElementsByName(`q${i}`);
        let val = null;
        for (const r of radios) { if (r.checked) val = r.value; }
        if (!val) { alert("å…¨ã¦å›ç­”ã—ã¦ãã ã•ã„"); return; }
        answers.push({ question: questions[i], value: val });
      }

      const btn = document.getElementById('submit-btn');
      
      // ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸç¬é–“ã®è¦‹ãŸç›®å¤‰æ›´
      btn.disabled = true;
      btn.innerText = "é€ä¿¡ã—ã¾ã—ãŸï¼";

      liff.getProfile().then(profile => {
        const postData = {
          mode: "diagnosis",
          userId: profile.userId,
          role: role,
          answers: answers
        };

        // 1. ãƒ‡ãƒ¼ã‚¿é€ä¿¡ï¼ˆéåŒæœŸã§æŠ•ã’ã£ã±ãªã—ï¼‰
        fetch(GAS_API_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(postData)
        });

        // 2. ã»ã¼å³åº§ï¼ˆ0.1ç§’å¾Œï¼‰ã«é–‰ã˜ã‚‹
        // â€»å®Œå…¨ã«0ç§’ã«ã™ã‚‹ã¨é€šä¿¡å‰ã«é–‰ã˜ã¦ã—ã¾ã†å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã€ä½“æ„Ÿå³åº§ã®0.1ç§’ã«è¨­å®š
        setTimeout(() => {
          liff.closeWindow();
        }, 100);
      })
      .catch(err => {
        alert("ã‚¨ãƒ©ãƒ¼: " + err);
        btn.disabled = false;
      });
    }
  </script>
</body>
</html>
